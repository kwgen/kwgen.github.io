<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="walk steps step by step">
<meta property="og:type" content="website">
<meta property="og:title" content="kwgen's blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="kwgen's blog">
<meta property="og:description" content="walk steps step by step">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="kwgen's blog">
<meta name="twitter:description" content="walk steps step by step">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="http://yoursite.com/"/>

  <title> kwgen's blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?2f4f9c38f8f14ec6d39fe7d5805a802f";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">kwgen's blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">Walk stepps step by step</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="st-search-show-outputs">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <form class="site-search-form">
  <input type="text" id="st-search-input" class="st-search-input st-default-search-input" />
</form>

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'RzzqSzZj1NXxJUdtoTcw','2.0.0');
</script>



    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/06/09/python_begin/" itemprop="url">
                  python beginner
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-06-09T12:00:00+08:00" content="2017-06-09">
              2017-06-09
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index">
                    <span itemprop="name">python</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2017/06/09/python_begin/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/06/09/python_begin/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="字符串的的宽带和精度"><a href="#字符串的的宽带和精度" class="headerlink" title="字符串的的宽带和精度"></a>字符串的的宽带和精度</h2><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">'%10f' % pi</div><div class="line">3.141593</div><div class="line">'%10.2f' % pi</div><div class="line">3.14</div><div class="line">'%.2f%' % pi</div><div class="line">3.14</div><div class="line">'%.5s' % 'Guido van Rossum'</div><div class="line">Guido</div><div class="line">'%.*s' % (5,'Guido van Rossum')</div><div class="line">Guido</div><div class="line">phonebook=&#123;'Cecil':'110'&#125;</div><div class="line">'Cecil's phone number is %(Cecl)s.' % phonebook</div><div class="line">Cecil's phone number is 110.</div></pre></td></tr></table></figure>
<h2 id="字典"><a href="#字典" class="headerlink" title="字典"></a>字典</h2><h3 id="copy-amp-deepcopy"><a href="#copy-amp-deepcopy" class="headerlink" title="copy&amp;deepcopy"></a>copy&amp;deepcopy</h3><p>copy 修改不会变，增加删除会变 避免这个可以采用deepcopy<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">x=&#123;<span class="string">'x'</span>:<span class="string">'1'</span>,<span class="string">'y'</span>:<span class="string">'2'</span>,<span class="string">'z'</span>:[<span class="string">'1'</span>,<span class="string">'2'</span>,<span class="string">'3'</span>]&#125;</div><div class="line">y = x.copy()</div><div class="line">y[<span class="string">'x'</span>]=<span class="string">'xx'</span></div><div class="line">y[<span class="string">'z'</span>].remove(<span class="string">'1'</span>)</div><div class="line">y[<span class="string">'z'</span>].append(<span class="string">'4'</span>)</div><div class="line"></div><div class="line">&#123;<span class="string">'y'</span>: <span class="string">'2'</span>, <span class="string">'x'</span>: <span class="string">'xx'</span>, <span class="string">'z'</span>: [<span class="string">'2'</span>, <span class="string">'3'</span>, <span class="string">'4'</span>]&#125;</div><div class="line">&#123;<span class="string">'y'</span>: <span class="string">'2'</span>, <span class="string">'x'</span>: <span class="string">'1'</span>, <span class="string">'z'</span>: [<span class="string">'2'</span>, <span class="string">'3'</span>, <span class="string">'4'</span>]&#125;</div></pre></td></tr></table></figure></p>
<h2 id="循环"><a href="#循环" class="headerlink" title="循环"></a>循环</h2><h3 id="布尔变量"><a href="#布尔变量" class="headerlink" title="布尔变量"></a>布尔变量</h3><p> 假：False None () “” 0 [] {}<br> 其它的都是真</p>
<h3 id="条件"><a href="#条件" class="headerlink" title="条件"></a>条件</h3><ol>
<li>== 两个东西是否相等（比较的是值）</li>
<li>is，is not 判断同一性质而不是相等性（== 不一定is，is一定==）</li>
<li>in，not in 成员<h3 id="断言"><a href="#断言" class="headerlink" title="断言"></a>断言</h3>调试使用<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">age = <span class="number">-1</span></div><div class="line"><span class="keyword">assert</span>  <span class="number">0</span>&lt;age&lt;<span class="number">100</span>,<span class="string">'The age must be realistic'</span></div><div class="line">AssertionError: The age must be realistic</div></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="迭代"><a href="#迭代" class="headerlink" title="迭代"></a>迭代</h3><h4 id="并行"><a href="#并行" class="headerlink" title="并行"></a>并行</h4><p>zip 将序列压缩一对一组合，返回元组列表，当两系列的长度不同时，最短序列用完停止<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">names = [<span class="string">'anne'</span>,<span class="string">'beth'</span>,<span class="string">'george'</span>,<span class="string">'domon'</span>]</div><div class="line">ages = [<span class="number">12</span>,<span class="number">45</span>,<span class="number">32</span>,<span class="number">102</span>]</div><div class="line"><span class="keyword">for</span> name,age <span class="keyword">in</span> zip(names,ages):</div><div class="line">    <span class="keyword">print</span> name,<span class="string">'is'</span>,age,<span class="string">'years old'</span></div></pre></td></tr></table></figure></p>
<h4 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h4><p>enumerate 提供迭代索引和值<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> index,string <span class="keyword">in</span> enumerate(names):</div><div class="line">    <span class="keyword">if</span> <span class="string">'ann'</span> <span class="keyword">in</span> string:</div><div class="line">        names[index] = <span class="string">'[censored]'</span></div></pre></td></tr></table></figure></p>
<h3 id="else子句"><a href="#else子句" class="headerlink" title="else子句"></a>else子句</h3><p>在循环中增加else，它仅在没有调用break时执行<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> math <span class="keyword">import</span> sqrt</div><div class="line"><span class="keyword">for</span> n <span class="keyword">in</span> range(<span class="number">99</span>,<span class="number">81</span>,<span class="number">-1</span>):</div><div class="line">    root = sqrt(n)</div><div class="line">    <span class="keyword">if</span> root==int(root):</div><div class="line">        <span class="keyword">break</span></div><div class="line"><span class="keyword">else</span>:</div><div class="line">    <span class="keyword">print</span> <span class="string">"Didn't find it"</span></div></pre></td></tr></table></figure></p>
<h3 id="列表推导式"><a href="#列表推导式" class="headerlink" title="列表推导式"></a>列表推导式</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[x*x <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">10</span>)]</div><div class="line">[<span class="number">0</span>, <span class="number">1</span>, <span class="number">4</span>, <span class="number">9</span>, <span class="number">16</span>, <span class="number">25</span>, <span class="number">36</span>, <span class="number">49</span>, <span class="number">64</span>, <span class="number">81</span>]</div><div class="line">[x*x <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">10</span>) <span class="keyword">if</span> x % <span class="number">3</span>==<span class="number">0</span>]</div><div class="line">[<span class="number">0</span>, <span class="number">9</span>, <span class="number">36</span>, <span class="number">81</span>]</div><div class="line">[[x,y] <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">3</span>) <span class="keyword">for</span> y <span class="keyword">in</span> range(<span class="number">3</span>)]</div><div class="line">[[<span class="number">0</span>, <span class="number">0</span>], [<span class="number">0</span>, <span class="number">1</span>], [<span class="number">0</span>, <span class="number">2</span>], [<span class="number">1</span>, <span class="number">0</span>], [<span class="number">1</span>, <span class="number">1</span>], [<span class="number">1</span>, <span class="number">2</span>], [<span class="number">2</span>, <span class="number">0</span>], [<span class="number">2</span>, <span class="number">1</span>], [<span class="number">2</span>, <span class="number">2</span>]]</div></pre></td></tr></table></figure>
<h3 id="语句"><a href="#语句" class="headerlink" title="语句"></a>语句</h3><ol>
<li>pass 代替空的代码块，什么都不执行（python中是不允许空的代码的）</li>
<li>del  删除变量（不会删除值本身，python是没办法删除值的，自己有垃圾处理机制）</li>
<li>exec 解析字符串为代码块<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">exec</span> <span class="string">"print 'hello'"</span> <span class="keyword">in</span> scope</div></pre></td></tr></table></figure>
</li>
</ol>
<p>in scope 表示为单独的命名空间，不会有变量和实际中的变量冲突</p>
<ol>
<li>eval 计算字符串的数字表达式的值<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">eva(<span class="string">'2*3'</span>)</div></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="抽象"><a href="#抽象" class="headerlink" title="抽象"></a>抽象</h2><h3 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h3><h4 id="文档化函数"><a href="#文档化函数" class="headerlink" title="文档化函数"></a>文档化函数</h4><ol>
<li>将字符串写在def语句后面或者模块和类的开头，以.<strong>doc</strong>查看</li>
<li>help(def)可以看到关于函数，包括它的文档字符串的信息<h4 id="关键字参数和默认值"><a href="#关键字参数和默认值" class="headerlink" title="关键字参数和默认值"></a>关键字参数和默认值</h4><ol>
<li>按照位置使用的参数是位置参数</li>
<li>关键字参数，即调用入参时指定那个参数；默认值，写在函数的默认赋值<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">print_param</span><span class="params">(greeting,name)</span>:</span></div><div class="line">    <span class="keyword">print</span> greeting,name</div><div class="line">print_param(name=<span class="string">"hello"</span>,greeting=<span class="string">"word"</span>)</div><div class="line">word hello</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">print_param</span><span class="params">(name=<span class="string">"hello"</span>,greeting=<span class="string">"word"</span>)</span>:</span></div><div class="line">    <span class="keyword">print</span> greeting,name</div><div class="line">print_param(greeting=<span class="string">'good'</span>)</div><div class="line">good hello</div></pre></td></tr></table></figure>
</li>
</ol>
</li>
</ol>
<h4 id="收集参数"><a href="#收集参数" class="headerlink" title="收集参数"></a>收集参数</h4><ol>
<li>*收集剩下所有参数，但不能处理关键字参数</li>
<li>** 处理关键字的收集<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">print_param</span><span class="params">(title,*params)</span>:</span></div><div class="line">    <span class="keyword">print</span> params</div><div class="line">print_param(<span class="string">'test'</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>)</div><div class="line">( <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</div></pre></td></tr></table></figure>
</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">print_params</span><span class="params">(x,y,z=<span class="number">3</span>,*pospar,**keypar)</span>:</span></div><div class="line">    <span class="keyword">print</span> x,y,z</div><div class="line">    <span class="keyword">print</span> pospar</div><div class="line">    <span class="keyword">print</span> keypar</div><div class="line">print_params(<span class="number">1</span>,<span class="number">2</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,p=<span class="number">1</span>,k=<span class="number">2</span>)</div><div class="line"><span class="number">1</span> <span class="number">2</span> <span class="number">4</span></div><div class="line">(<span class="number">5</span>, <span class="number">6</span>)</div><div class="line">&#123;<span class="string">'p'</span>: <span class="number">1</span>, <span class="string">'k'</span>: <span class="number">2</span>&#125;</div></pre></td></tr></table></figure>
<h4 id="参数收集的逆过程"><a href="#参数收集的逆过程" class="headerlink" title="参数收集的逆过程"></a>参数收集的逆过程</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(x,y)</span>:</span></div><div class="line">    <span class="keyword">print</span> x+y</div><div class="line">params=(<span class="number">1</span>,<span class="number">2</span>)</div><div class="line">add(*params)</div></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">print_params</span><span class="params">(**x)</span>:</span></div><div class="line">    <span class="keyword">print</span> x.get(<span class="string">'name'</span>),x.get(<span class="string">'age'</span>)</div><div class="line">params = &#123;<span class="string">'name'</span>:<span class="string">'smith'</span>,<span class="string">'age'</span>:<span class="string">'18'</span>&#125;</div><div class="line">print_params(**params)</div></pre></td></tr></table></figure>
<h3 id="函数和方法"><a href="#函数和方法" class="headerlink" title="函数和方法"></a>函数和方法</h3><ol>
<li>self 是方法和函数的区别，也可以将这一特性绑在一个函数上</li>
<li>可以使用其他变量引用同一个方法<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Class</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">method</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">print</span> <span class="string">'I have a self'</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">function</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">print</span> <span class="string">'I dont....'</span></div><div class="line">instance = Class()</div><div class="line">instance.method()</div><div class="line">instance.method = function</div><div class="line">instance.method()</div><div class="line">I have a self</div><div class="line">I dont....</div></pre></td></tr></table></figure>
</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bird</span>:</span></div><div class="line">    song = <span class="string">'Squaawk'</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">sing</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">print</span> self.song</div><div class="line">bird = Bird()</div><div class="line">bird.sing()</div><div class="line">birdsong = bird.sing</div><div class="line">birdsong()</div><div class="line">Squaawk</div><div class="line">Squaawk</div></pre></td></tr></table></figure>
<h4 id="函数私有"><a href="#函数私有" class="headerlink" title="函数私有"></a>函数私有</h4><p>方法前加“__”代表私有方法，私有方法可以一般不可以外部调用<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">class Secretive:</div><div class="line">    def __inaccessible(self):</div><div class="line">        print "Bet you can't see me"</div><div class="line">    def accessibble(self):</div><div class="line">        print "Thesecret message is:"</div><div class="line">        self.__inaccessible()</div><div class="line">s= Secretive()</div><div class="line">s.accessibble()</div><div class="line">s._Secretive__inaccessible()</div><div class="line"></div><div class="line">Thesecret message is:</div><div class="line">Bet you can't see me</div><div class="line">Bet you can't see me</div></pre></td></tr></table></figure></p>
<h3 id="超类"><a href="#超类" class="headerlink" title="超类"></a>超类</h3><ol>
<li>在类申明的时候在（）内指明超类</li>
<li>判断一个类是否是另外一个类的子类用issubclass函数</li>
<li>知道已知类的基类<strong>base</strong></li>
<li>知道一个对象属于哪个类<strong>class</strong></li>
<li>一个类可以有多个超类，先继承的方法会重写后继承的方法</li>
<li>接口//TODO</li>
</ol>
<h2 id="异常"><a href="#异常" class="headerlink" title="异常"></a>异常</h2><h3 id="自定义异常"><a href="#自定义异常" class="headerlink" title="自定义异常"></a>自定义异常</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">raise</span> Exception(<span class="string">'this a test error'</span>)</div></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">somethingException</span><span class="params">(Exception)</span>:</span><span class="keyword">pass</span></div></pre></td></tr></table></figure>
<h3 id="捕捉异常"><a href="#捕捉异常" class="headerlink" title="捕捉异常"></a>捕捉异常</h3><ol>
<li><p>else在没有异常时执行</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span>:</div><div class="line">    <span class="keyword">print</span> <span class="string">"try"</span></div><div class="line"><span class="keyword">except</span>(ZeroDivisionError,TypeError),e:</div><div class="line">    <span class="keyword">print</span> e</div><div class="line"><span class="keyword">else</span>:</div><div class="line">    <span class="keyword">print</span> <span class="string">"esle"</span></div><div class="line"><span class="keyword">finally</span>:</div><div class="line">    <span class="keyword">print</span> <span class="string">"finally"</span></div><div class="line"><span class="keyword">try</span></div><div class="line">esle</div><div class="line"><span class="keyword">finally</span></div></pre></td></tr></table></figure>
</li>
<li><p>捕捉全部异常</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">except</span> Exception,e:</div></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="方法、属性、迭代器"><a href="#方法、属性、迭代器" class="headerlink" title="方法、属性、迭代器"></a>方法、属性、迭代器</h2><h3 id="构造方法"><a href="#构造方法" class="headerlink" title="构造方法"></a>构造方法</h3><h4 id="重写一般的方法"><a href="#重写一般的方法" class="headerlink" title="重写一般的方法"></a>重写一般的方法</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">print</span> <span class="string">"hello I am A"</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span><span class="params">(A)</span>:</span><span class="keyword">pass</span></div><div class="line">b = B()</div><div class="line">b.hello()</div><div class="line">hello I am A</div></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span><span class="params">(A)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">print</span> <span class="string">"hello I am B"</span></div><div class="line">b = B()</div><div class="line">b.hello()</div><div class="line"></div><div class="line">hello I am B</div></pre></td></tr></table></figure>
<h4 id="重新构造方法"><a href="#重新构造方法" class="headerlink" title="重新构造方法"></a>重新构造方法</h4><p>子类重写了父类的构造方法，而又没有调用父类的构造方法，那么父类将不能使用子类的属性和方法<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bird</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        self.hungry = <span class="keyword">True</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">eat</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">if</span> self.hungry:</div><div class="line">            <span class="keyword">print</span> <span class="string">'Annnn.....'</span></div><div class="line">            self.hungry = <span class="keyword">False</span></div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="keyword">print</span> <span class="string">'No,thinks.'</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SongBird</span><span class="params">(Bird)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        self.sound = <span class="string">'Squawk!'</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">sing</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">print</span> self.sound</div><div class="line"></div><div class="line">sb = SongBird()</div><div class="line">sb.sing()</div><div class="line">sb.eat()</div><div class="line">Squawk!</div><div class="line">AttributeError: SongBird instance has no attribute <span class="string">'hungry'</span></div></pre></td></tr></table></figure></p>
<p>在子类的构造方法中加入,可使用父类的方法属性<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Bird.__init__(self)</div><div class="line">或</div><div class="line">super(SongBird,self).__init__()</div></pre></td></tr></table></figure></p>
<h3 id="成员访问"><a href="#成员访问" class="headerlink" title="成员访问"></a>成员访问</h3><h4 id="基本的序列和映射规则（len-self-、getitme-self-key-、setitme-self-key-value-、delitem-self-key-）"><a href="#基本的序列和映射规则（len-self-、getitme-self-key-、setitme-self-key-value-、delitem-self-key-）" class="headerlink" title="基本的序列和映射规则（len(self)、getitme(self,key)、setitme(self,key,value)、delitem(self,key)）"></a>基本的序列和映射规则（<strong>len</strong>(self)、<strong>getitme</strong>(self,key)、<strong>setitme</strong>(self,key,value)、<strong>delitem</strong>(self,key)）</h4><ol>
<li>这个类没有实现<strong>delitem</strong>,那么删除元素时非法的;这个类没有<strong>len</strong>方法，代表是无线长的</li>
<li>子类化列表，字典和字符串<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">checkIndex</span><span class="params">(key)</span>:</span></div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> isinstance(key, (int, long)): <span class="keyword">raise</span> TypeError</div><div class="line">    <span class="keyword">if</span> key &lt; <span class="number">0</span>: <span class="keyword">raise</span> IndexError</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArithmeticSequence</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, start=<span class="number">0</span>, step=<span class="number">1</span>)</span>:</span></div><div class="line">        self.start = start</div><div class="line">        self.step = step</div><div class="line">        self.changed = &#123;&#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getitem__</span><span class="params">(self, key)</span>:</span></div><div class="line">        checkIndex(key)</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            <span class="keyword">print</span> self.changed[key]</div><div class="line">        <span class="keyword">except</span> KeyError:</div><div class="line">            <span class="keyword">print</span> self.start + key * self.step</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setitem__</span><span class="params">(self, key, value)</span>:</span></div><div class="line">        checkIndex(key)</div><div class="line">        self.changed[key] = value</div><div class="line">s = ArithmeticSequence(<span class="number">1</span>,<span class="number">2</span>)</div><div class="line">s[<span class="number">4</span>]</div><div class="line">s[<span class="number">4</span>]=<span class="number">2</span></div><div class="line">s[<span class="number">4</span>]</div><div class="line">s[<span class="number">5</span>]</div><div class="line"><span class="keyword">del</span> s[<span class="number">4</span>]</div><div class="line"></div><div class="line"><span class="number">9</span></div><div class="line"><span class="number">2</span></div><div class="line"><span class="number">11</span></div><div class="line">AttributeError: ArithmeticSequence instance has no attribute <span class="string">'__delitem__'</span></div></pre></td></tr></table></figure>
</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">CounterList</span><span class="params">(list)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,*args)</span>:</span></div><div class="line">        super(CounterList,self).__init__(args)</div><div class="line">        self.count = <span class="number">0</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getitem__</span><span class="params">(self, index)</span>:</span></div><div class="line">        self.count+=<span class="number">1</span></div><div class="line">        <span class="keyword">return</span> super(CounterList,self).__getitem__(index)</div><div class="line"><span class="keyword">print</span> CounterList(range(<span class="number">10</span>))</div><div class="line"></div><div class="line">[[<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>]]</div></pre></td></tr></table></figure>
<h3 id="property-函数"><a href="#property-函数" class="headerlink" title="property 函数"></a>property 函数</h3><p>函数有4个参数 fget,fset,fdel,doc。没有参数不可读不可写，一个只读、只写；doc属性可写，并且有个文档字符串<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">__metaclass__ = type</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Rectangle</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        self.width = <span class="number">0</span></div><div class="line">        self.height = <span class="number">0</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">setSize</span><span class="params">(self,size)</span>:</span></div><div class="line">        self.width ,self.height = size</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getSize</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> self.width,self.height</div><div class="line">    size = property(getSize,setSize)</div><div class="line">r = Rectangle()</div><div class="line">r.width=<span class="number">10</span></div><div class="line">r.height=<span class="number">10</span></div><div class="line"><span class="keyword">print</span> r.size</div><div class="line">r.size = <span class="number">150</span> , <span class="number">150</span></div><div class="line"><span class="keyword">print</span> r.width</div><div class="line">(<span class="number">10</span>, <span class="number">10</span>)</div><div class="line"><span class="number">150</span></div></pre></td></tr></table></figure></p>
<h3 id="静态方法和类成员方法"><a href="#静态方法和类成员方法" class="headerlink" title="静态方法和类成员方法"></a>静态方法和类成员方法</h3><p>类成员方法在定义的时候要用Cls类，两者都能直接被类调用；在创建时分别装入staticmethod、classmethod<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">__metaclass__ = type</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Myclass</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">smeth</span><span class="params">()</span>:</span></div><div class="line">        <span class="keyword">print</span> <span class="string">'this is a static method'</span></div><div class="line">    smeth = staticmethod(smeth)</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cmeth</span><span class="params">(Cls)</span>:</span></div><div class="line">        <span class="keyword">print</span> <span class="string">'this is a class method'</span>,Cls</div><div class="line">    cmeth = classmethod(cmeth)</div><div class="line"></div><div class="line">Myclass.smeth()</div><div class="line">Myclass.cmeth()</div></pre></td></tr></table></figure></p>
<p>或<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">__metaclass__ = type</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Myclass</span>:</span></div><div class="line"><span class="meta">    @staticmethod</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">smeth</span><span class="params">()</span>:</span></div><div class="line">        <span class="keyword">print</span> <span class="string">'this is a static method'</span></div><div class="line"><span class="meta">    @classmethod</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cmeth</span><span class="params">(Cls)</span>:</span></div><div class="line">        <span class="keyword">print</span> <span class="string">'this is a class method'</span>,Cls</div></pre></td></tr></table></figure></p>
<h3 id="拦截-TODO"><a href="#拦截-TODO" class="headerlink" title="拦截// TODO"></a>拦截// TODO</h3><ol>
<li><strong>getattribute</strong>(self,name) 当特性name被访问时调用</li>
<li><strong>getattr</strong>(self,name) 当特性name被访问且对象没有相应的特性时被调用（新式类中使用）</li>
<li><strong>setattr</strong>(self,name,value) 当试图给特性name赋值时会被自动调用</li>
<li><strong>delattr</strong>(self,name) 当试图删除特性name时被自动调用</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">__metaclass__ = type</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Rectangle</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        self.width = <span class="number">0</span></div><div class="line">        self.height = <span class="number">0</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setattr__</span><span class="params">(self, name, value)</span>:</span></div><div class="line">        <span class="keyword">if</span> name == <span class="string">'size'</span>:</div><div class="line">            self.width,self.height = value</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            self.__dict__[name] = value</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span><span class="params">(self, name)</span>:</span></div><div class="line">        <span class="keyword">if</span> name==<span class="string">'size'</span>:</div><div class="line">            <span class="keyword">print</span> self.width,self.height</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="keyword">raise</span> AttributeError</div></pre></td></tr></table></figure>
<h3 id="迭代器"><a href="#迭代器" class="headerlink" title="迭代器"></a>迭代器</h3><ol>
<li>实现了<strong>iter</strong>方法的对象时可迭代的，实现了next方法时隔迭代器</li>
<li>从迭代得到序列<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Fibs</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        self.a = <span class="number">0</span></div><div class="line">        self.b = <span class="number">1</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">next</span><span class="params">(self)</span>:</span></div><div class="line">        self.a,self.b = self.b,self.a+self.b</div><div class="line">        <span class="keyword">if</span> self.b &gt;<span class="number">1024</span>:<span class="keyword">raise</span> StopIteration</div><div class="line">        <span class="keyword">return</span> self.b</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__iter__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> self</div><div class="line">fibs = Fibs()</div><div class="line"><span class="keyword">for</span> f <span class="keyword">in</span> fibs:</div><div class="line">    <span class="keyword">print</span> f</div><div class="line"></div><div class="line"><span class="keyword">print</span> list(fibs)</div></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="递归生成器TODO"><a href="#递归生成器TODO" class="headerlink" title="递归生成器TODO"></a>递归生成器TODO</h3><ol>
<li>yield关键字，当代码执行时停止返回当前的值，当再次调用时接着往下执行</li>
</ol>
<h2 id="模块"><a href="#模块" class="headerlink" title="模块"></a>模块</h2><h3 id="模块中增加测试代码"><a href="#模块中增加测试代码" class="headerlink" title="模块中增加测试代码"></a>模块中增加测试代码</h3><p>在直接运行下会执行测试代码而在模块导入时不会执行测试代码<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">print</span> <span class="string">'hello world'</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">()</span>:</span></div><div class="line">    hello()</div><div class="line"><span class="keyword">if</span> __name__==<span class="string">'__main__'</span>:test()</div></pre></td></tr></table></figure></p>
<h3 id="模块可用"><a href="#模块可用" class="headerlink" title="模块可用"></a>模块可用</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> sys,pprint</div><div class="line">pprint.pprint(sys.path)</div><div class="line"></div><div class="line">[<span class="string">'D:/work/python_work_space/accidence'</span>,</div><div class="line"> <span class="string">'C:\\Users\\18702\\.IntelliJIdea2017.1\\config\\plugins\\python\\helpers\\pydev'</span>,</div><div class="line"> <span class="string">'D:\\software\\install\\python-2.5.2\\lib\\site-packages\\setuptools-1.4.2-py2.5.egg'</span>,</div><div class="line"> <span class="string">'D:\\software\\install\\python-2.5.2\\lib\\site-packages\\pip-1.1-py2.5.egg'</span>,</div><div class="line"> <span class="string">'D:\\work\\python_work_space\\accidence'</span>,</div><div class="line"> <span class="string">'C:\\Users\\18702\\.IntelliJIdea2017.1\\config\\plugins\\python\\helpers\\pydev'</span>,</div><div class="line"> <span class="string">'C:\\WINDOWS\\SYSTEM32\\python25.zip'</span>,</div><div class="line"> <span class="string">'D:\\software\\install\\python-2.5.2\\DLLs'</span>,</div><div class="line"> <span class="string">'D:\\software\\install\\python-2.5.2\\lib'</span>,</div><div class="line"> <span class="string">'D:\\software\\install\\python-2.5.2\\lib\\plat-win'</span>,</div><div class="line"> <span class="string">'D:\\software\\install\\python-2.5.2\\lib\\lib-tk'</span>,</div><div class="line"> <span class="string">'D:\\software\\install\\python-2.5.2'</span>,</div><div class="line"> <span class="string">'D:\\software\\install\\python-2.5.2\\lib\\site-packages'</span>]</div></pre></td></tr></table></figure>
<ol>
<li>将模块放在上面的目录下</li>
<li>设置PYTHONPATH环境变量</li>
</ol>
<h2 id="文件和流"><a href="#文件和流" class="headerlink" title="文件和流"></a>文件和流</h2><h3 id="文件模式"><a href="#文件模式" class="headerlink" title="文件模式"></a>文件模式</h3><ol>
<li>open(),文件路径，文件模式，缓冲</li>
<li>‘r’ 读模式</li>
<li>‘w’写模式</li>
<li>‘a’追加模式</li>
<li>‘b’二进制模式，用于处理二进制文件和其他模式一起使用‘rb’</li>
<li>‘+’读写模式，可添加到其他模式中使用</li>
</ol>
<h3 id="管式输出"><a href="#管式输出" class="headerlink" title="管式输出"></a>管式输出</h3><p>$ cat somefile.txt | pyhton somescript.py | sort</p>
<ol>
<li>cat somefile.txt 读取文件内容到标准输出sys.stdout</li>
<li>pyhton somescript.py 读取文本逻辑处理然后输出</li>
<li>sort 重标准输入sys.stdin读取所用文本，按字母排序，然后把结果写入标准输出<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> sys</div><div class="line">text = sys.stdin.read()</div><div class="line">words = text.split()</div><div class="line">wordcount = len(words)</div><div class="line"><span class="keyword">print</span> <span class="string">'Wordcount:'</span> wordcount</div></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="读和写"><a href="#读和写" class="headerlink" title="读和写"></a>读和写</h3><ol>
<li>read()读取剩下全部，read(4) 读取剩下4个字符</li>
<li>readline() 读取一行，readlines()读取文件中所用行并且返回一个列表</li>
<li>write(‘xxx’) 写入一个字符串</li>
<li>writelines(lines)写入一个列表</li>
</ol>
<h3 id="文件内容迭代"><a href="#文件内容迭代" class="headerlink" title="文件内容迭代"></a>文件内容迭代</h3><h4 id="fileInput"><a href="#fileInput" class="headerlink" title="fileInput"></a>fileInput</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> fileinput</div><div class="line">f = fileinput.input(<span class="string">r'D:\work\python.txt'</span>)</div><div class="line"><span class="keyword">for</span> line <span class="keyword">in</span> f:</div><div class="line">    <span class="keyword">print</span> line</div></pre></td></tr></table></figure>
<h4 id="文件对象的迭代"><a href="#文件对象的迭代" class="headerlink" title="文件对象的迭代"></a>文件对象的迭代</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> line <span class="keyword">in</span> open(<span class="string">r'D:\work\python.txt'</span>):</div><div class="line">    <span class="keyword">print</span> line</div><div class="line">list(open(<span class="string">r'D:\work\python.txt'</span>))</div><div class="line">a,b,c = open(<span class="string">r'D:\work\python.txt'</span>)</div></pre></td></tr></table></figure>
<h2 id="网络编程"><a href="#网络编程" class="headerlink" title="网络编程"></a>网络编程</h2><h3 id="socket套接字"><a href="#socket套接字" class="headerlink" title="socket套接字"></a>socket套接字</h3><ol>
<li><p>套接字是两个端点的程序之间的“信息通道”；一个套接字就是socket模块中的socket类的一个实例，它有3个参数：地址、流或数据报、协议（默认为0）</p>
<p>服务端</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> socket</div><div class="line">s = socket.socket()</div><div class="line">host = socket.gethostname()</div><div class="line">port = <span class="number">112312</span></div><div class="line">s.bind((host,port))</div><div class="line">s.listen(<span class="number">4</span>)</div><div class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">    c,addr = s.accept()</div><div class="line">    <span class="keyword">print</span> s,addr</div><div class="line">    c.send(<span class="string">"Thank you for connecting"</span>)</div></pre></td></tr></table></figure>
</li>
</ol>
<p>各户端<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> socket</div><div class="line">s = socket.socket()</div><div class="line">host = socket.gethostname()</div><div class="line">port = <span class="number">112312</span></div><div class="line">s.connect((host,port))</div><div class="line">f = s.recv(<span class="number">1024</span>)</div><div class="line"><span class="keyword">print</span> f</div></pre></td></tr></table></figure></p>
<h4 id="urllib和urllib2"><a href="#urllib和urllib2" class="headerlink" title="urllib和urllib2"></a>urllib和urllib2</h4><p>webpage对象可读取关闭；urlretrieve下载网页；如果urlretrieve没有指明是下载到哪个文件，那么保存在临时文件中，urlcleanup清除临时文件<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> urlopen</div><div class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> urlretrieve</div><div class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> urlcleanup</div><div class="line">webpage = urlopen(<span class="string">"http://www.python.org"</span>)</div><div class="line">    <span class="keyword">print</span> line.read()</div><div class="line">f,h = urlretrieve(<span class="string">"http://www.python.org"</span>,<span class="string">"c:\\a.html"</span>)</div><div class="line"><span class="keyword">print</span> f,h</div><div class="line">urlcleanup()</div></pre></td></tr></table></figure></p>
<h2 id="常用类"><a href="#常用类" class="headerlink" title="常用类"></a>常用类</h2>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/09/quartz/" itemprop="url">
                  quartz
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-04-09T12:00:00+08:00" content="2017-04-09">
              2017-04-09
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/spring-boot/" itemprop="url" rel="index">
                    <span itemprop="name">spring boot</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2017/04/09/quartz/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/04/09/quartz/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="一-简单的spring-boot-的quartz"><a href="#一-简单的spring-boot-的quartz" class="headerlink" title="一.简单的spring boot 的quartz"></a>一.简单的spring boot 的quartz</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">@Component</div><div class="line">@Configurable</div><div class="line">@EnableScheduling</div><div class="line">public class TaskScheduler &#123;</div><div class="line">    private static Logger log = LoggerFactory.getLogger(TaskScheduler.class);</div><div class="line">    @Scheduled(cron = &quot;0 0 2 * * ?&quot;) // 每天2am</div><div class="line">    public void test() &#123;</div><div class="line">        //do something</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="二-java-自带的quartz"><a href="#二-java-自带的quartz" class="headerlink" title="二.java 自带的quartz"></a>二.java 自带的quartz</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line">import java.util.*;</div><div class="line"></div><div class="line">import javax.annotation.PostConstruct;</div><div class="line"></div><div class="line">import org.slf4j.*;</div><div class="line">import org.springframework.beans.factory.annotation.Autowired;</div><div class="line">import org.springframework.stereotype.Component;</div><div class="line"></div><div class="line">@Component</div><div class="line">public class TaskScheduler &#123;</div><div class="line">    private static Logger log = LoggerFactory.getLogger(TaskScheduler.class);</div><div class="line"></div><div class="line">    @Autowired</div><div class="line">    private StartCatchService startCatchService;//定时任务的方法存放</div><div class="line"></div><div class="line">    @Autowired</div><div class="line">    private QuartzRepository quartzRepository;//获取定时任务的参数dao层</div><div class="line">    @Autowired</div><div class="line">    public QuartzLogRepository quartzLogRepository; 定时任务日志记录</div><div class="line"></div><div class="line">    @PostConstruct</div><div class="line">    public void doScheduleAuto() &#123;</div><div class="line">        List&lt;Quartz&gt; quartzList = quartzRepository.findAll();</div><div class="line">        for (Quartz quartz : quartzList) &#123;</div><div class="line">            int status = quartz.getStatus();</div><div class="line">            if (StatusEnum.VALID.getValue() == status) &#123;</div><div class="line">                addSchedule(quartz);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    public void addSchedule(Quartz quartz) &#123;</div><div class="line"></div><div class="line">        String method = quartz.getMethod();// 要执行的方法</div><div class="line">        String startTime = quartz.getStartTime();// 执行的开始时间</div><div class="line">        String period = quartz.getPeriod();// 执行的间隔</div><div class="line">        String explain = quartz.getExplain();// 说明</div><div class="line">        Timer timer = new Timer();</div><div class="line">        timer.scheduleAtFixedRate(new TimerTask() &#123;</div><div class="line">            public void run() &#123;</div><div class="line">                QuartzLog quartzLog = new QuartzLog(new Date(), method, 1, 0, &quot;sucess&quot;);</div><div class="line">                try &#123;</div><div class="line">                    StartCatchService.class.getMethod(method).invoke(startCatchService);</div><div class="line">                &#125; catch (Exception e) &#123;</div><div class="line">                    quartzLog.setResult(2);</div><div class="line">                    quartzLog.setMessage(&quot;fail&quot;);</div><div class="line">                    log.info(&quot;开启定时调度爬虫失败，method=&#123;&#125;,startTime=&#123;&#125;,period=&#123;&#125;,explain=&#123;&#125;&quot;, method, startTime, period, explain);</div><div class="line">                &#125;</div><div class="line">                log.info(&quot;定时调度爬取数据sucess：explain=&#123;&#125;&quot;, explain);</div><div class="line">                quartzLogRepository.save(quartzLog);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">        &#125;, DataUtils.delayed(startTime), Long.valueOf(period));// 这里设定将延时每天固定执行</div><div class="line">        log.info(&quot;加载定时调度爬取数据：method=&#123;&#125;,startTime=&#123;&#125;,period=&#123;&#125;,explain=&#123;&#125;，sucess&quot;, method, startTime, period, explain);</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>将quartz的调度信息放在表中，启动项目后自动加载</p>
<h2 id="三-利用第三方和spring结合"><a href="#三-利用第三方和spring结合" class="headerlink" title="三.利用第三方和spring结合"></a>三.利用第三方和spring结合</h2><p>导入jar包</p>
<pre><code>&lt;dependency&gt;
    &lt;groupId&gt;org.quartz-scheduler&lt;/groupId&gt;
    &lt;artifactId&gt;quartz&lt;/artifactId&gt;
    &lt;version&gt;2.2.2&lt;/version&gt;
&lt;/dependency&gt;
</code></pre><p>1.<a href="http://blog.csdn.net/qwe6112071/article/details/50989192" target="_blank" rel="external">根据quartz自带的sql创建表</a><br>2.建立实体TaskJob用于存储和展现quartz信息,创建用于记录job运行的日志表<br>3.<a href="http://orange5458.iteye.com/blog/1170777" target="_blank" rel="external">创建quartz.properties</a><br>添加配置<br>–jobListener<br>org.quartz.jobListener.globalLogJobListener.class=<br>–jobFactory<br>org.quartz.scheduler.jobFactory.class=</p>
<p>4.创建jobFactory用于job中spring的注入<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">import org.quartz.spi.TriggerFiredBundle;</div><div class="line">import org.springframework.beans.factory.annotation.Autowired;</div><div class="line">import org.springframework.beans.factory.config.AutowireCapableBeanFactory;</div><div class="line">import org.springframework.scheduling.quartz.SpringBeanJobFactory;</div><div class="line">import org.springframework.stereotype.Component;</div><div class="line"></div><div class="line">@Component</div><div class="line">public class AutowireJobFactory extends SpringBeanJobFactory &#123;</div><div class="line"></div><div class="line">    @Autowired</div><div class="line">    private AutowireCapableBeanFactory beanFactory;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    protected Object createJobInstance(TriggerFiredBundle bundle) throws Exception &#123;</div><div class="line">        Object jobInstance = super.createJobInstance(bundle);</div><div class="line">        beanFactory.autowireBean(jobInstance);</div><div class="line">        return jobInstance;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>5.创建quartz的config文件由于读取配置和生成SchedulerFactoryBean<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line">import org.springframework.beans.factory.annotation.Autowired;</div><div class="line">import org.springframework.beans.factory.config.PropertiesFactoryBean;</div><div class="line">import org.springframework.context.ApplicationContext;</div><div class="line">import org.springframework.context.annotation.Bean;</div><div class="line">import org.springframework.context.annotation.Configuration;</div><div class="line">import org.springframework.core.io.ClassPathResource;</div><div class="line">import org.springframework.scheduling.annotation.EnableScheduling;</div><div class="line">import org.springframework.scheduling.quartz.SchedulerFactoryBean;</div><div class="line"></div><div class="line">import java.io.IOException;</div><div class="line">import java.util.Properties;</div><div class="line"></div><div class="line">@Configuration</div><div class="line">@EnableScheduling</div><div class="line">public class SchedulerConfig &#123;</div><div class="line"></div><div class="line">    @Autowired</div><div class="line">    private AutowireJobFactory autowireJobFactory;</div><div class="line"></div><div class="line">    @Bean</div><div class="line">    public SchedulerFactoryBean schedulerFactoryBean() throws IOException &#123;</div><div class="line">        SchedulerFactoryBean factory = new SchedulerFactoryBean();</div><div class="line"></div><div class="line">        factory.setOverwriteExistingJobs(true);</div><div class="line"></div><div class="line">        // 延时启动</div><div class="line">        factory.setStartupDelay(20);</div><div class="line"></div><div class="line">        // 加载quartz数据源配置</div><div class="line">        factory.setQuartzProperties(quartzProperties());</div><div class="line">        factory.setAutoStartup(false);</div><div class="line">        // 自定义Job Factory，用于Spring注入</div><div class="line">        factory.setJobFactory(autowireJobFactory);</div><div class="line"></div><div class="line">        return factory;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * 加载quartz数据源配置</div><div class="line">     *</div><div class="line">     * @return</div><div class="line">     * @throws IOException</div><div class="line">     */</div><div class="line">    @Bean</div><div class="line">    public Properties quartzProperties() throws IOException &#123;</div><div class="line">        PropertiesFactoryBean propertiesFactoryBean = new PropertiesFactoryBean();</div><div class="line">        propertiesFactoryBean.setLocation(new ClassPathResource(&quot;/quartz.properties&quot;));</div><div class="line">        propertiesFactoryBean.afterPropertiesSet();</div><div class="line">        return propertiesFactoryBean.getObject();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>6.创建quartz的service层，用于创建和控制job<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div></pre></td><td class="code"><pre><div class="line">import java.text.ParseException;</div><div class="line">import java.util.Date;</div><div class="line">import java.util.List;</div><div class="line">import java.util.Map;</div><div class="line">import java.util.Set;</div><div class="line"></div><div class="line">import javax.annotation.PostConstruct;</div><div class="line"></div><div class="line">import org.quartz.*;</div><div class="line">import org.quartz.Trigger.TriggerState;</div><div class="line">import org.quartz.impl.matchers.GroupMatcher;</div><div class="line">import org.quartz.impl.triggers.CronTriggerImpl;</div><div class="line">import org.slf4j.Logger;</div><div class="line">import org.slf4j.LoggerFactory;</div><div class="line">import org.springframework.beans.factory.annotation.Autowired;</div><div class="line">import org.springframework.boot.autoconfigure.condition.ConditionalOnClass;</div><div class="line">import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;</div><div class="line">import org.springframework.context.ApplicationContext;</div><div class="line">import org.springframework.context.annotation.Lazy;</div><div class="line">import org.springframework.scheduling.quartz.SchedulerFactoryBean;</div><div class="line">import org.springframework.stereotype.Service;</div><div class="line"></div><div class="line">import com.google.common.collect.Lists;</div><div class="line"></div><div class="line">import cn.swao.framework.model.TaskJob;</div><div class="line"></div><div class="line">@Service</div><div class="line">public class SchedulerService &#123;</div><div class="line">    private static Logger log = LoggerFactory.getLogger(SchedulerService.class);</div><div class="line"></div><div class="line">    @Autowired</div><div class="line">    private SchedulerFactoryBean schedulerFactoryBean;</div><div class="line"></div><div class="line">    @Autowired</div><div class="line">    private ApplicationContext applicationContext;</div><div class="line"></div><div class="line">    private Scheduler scheduler;</div><div class="line"></div><div class="line">    @PostConstruct</div><div class="line">    public void init() throws SchedulerException &#123;</div><div class="line">        scheduler = schedulerFactoryBean.getScheduler();</div><div class="line">        scheduler.getContext().put(&quot;applicationContext&quot;, applicationContext);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * 启动quartz</div><div class="line">     */</div><div class="line">    public void start() throws SchedulerException &#123;</div><div class="line">        if (!scheduler.isStarted())</div><div class="line">            scheduler.start();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * 创建任务</div><div class="line">     */</div><div class="line">    public boolean createJob(TaskJob taskJob) throws SchedulerException &#123;</div><div class="line">        boolean result = false;</div><div class="line">        if (taskJob != null) &#123;</div><div class="line">            try &#123;</div><div class="line">                JobDetail jobDetail = this.createJobDetail(taskJob.getJobName(), taskJob.getJobGroup(), taskJob.getJobClassName(), taskJob.getDataMap(), taskJob.getDescription());</div><div class="line">                List&lt;Map&lt;String, String&gt;&gt; triggerList = taskJob.getTriggerList();</div><div class="line">                for (int i = 0; i &lt; triggerList.size(); i++) &#123;</div><div class="line">                    Map&lt;String, String&gt; map = triggerList.get(i);</div><div class="line">                    CronTriggerImpl trigger = (CronTriggerImpl) this.createTrigger(taskJob.getTriggerName(map), taskJob.getTriggerGroup(map), taskJob.getCronExpression(map));</div><div class="line">                    if (i &gt; 0) &#123;</div><div class="line">                        trigger.setJobName(taskJob.getJobName());</div><div class="line">                        trigger.setJobName(taskJob.getJobGroup());</div><div class="line">                        scheduler.scheduleJob(trigger);</div><div class="line">                    &#125; else &#123;</div><div class="line">                        scheduler.scheduleJob(jobDetail, trigger);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                log.info(&quot;createJob success taskJob:&#123;&#125;&quot;, taskJob);</div><div class="line">                result = true;</div><div class="line">            &#125; catch (Exception e) &#123;</div><div class="line">                log.info(taskJob.getJobClassName() + &quot;.createJob (添加任务 ) 发生异常&quot;, e);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        return result;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * 修改一个任务的触发时间</div><div class="line">     */</div><div class="line">    public void modifyJobTime(String triggerName, String triggerGroupName, String time) throws SchedulerException, ParseException &#123;</div><div class="line"></div><div class="line">        TriggerKey triggerKey = TriggerKey.triggerKey(triggerName, triggerGroupName);</div><div class="line"></div><div class="line">        CronTrigger trigger = (CronTrigger) scheduler.getTrigger(triggerKey);</div><div class="line">        if (trigger == null) &#123;</div><div class="line">            return;</div><div class="line">        &#125;</div><div class="line">        String oldTime = trigger.getCronExpression();</div><div class="line">        if (!oldTime.equalsIgnoreCase(time)) &#123;</div><div class="line">            // 触发器</div><div class="line">            TriggerBuilder&lt;Trigger&gt; triggerBuilder = TriggerBuilder.newTrigger();</div><div class="line">            // 触发器名,触发器组</div><div class="line">            triggerBuilder.withIdentity(triggerName, triggerGroupName);</div><div class="line">            triggerBuilder.startNow();</div><div class="line">            // 触发器时间设定</div><div class="line">            triggerBuilder.withSchedule(CronScheduleBuilder.cronSchedule(time));</div><div class="line">            // 创建Trigger对象</div><div class="line">            trigger = (CronTrigger) triggerBuilder.build();</div><div class="line">            // 修改一个任务的触发时间</div><div class="line">            this.rescheduleJob(triggerKey, trigger);</div><div class="line">            log.info(&quot;modify success triggerName:&#123;&#125;,triggerGroupName:&#123;&#125;,time:&#123;&#125;&quot;, triggerName, triggerGroupName, time);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * 追加触发器</div><div class="line">     */</div><div class="line">    public void addJobTime(String jobName, String jobGroup, String triggerName, String triggerGroupName, String time) throws SchedulerException, ParseException &#123;</div><div class="line">        TriggerKey triggerKey = TriggerKey.triggerKey(triggerName, triggerGroupName);</div><div class="line">        JobKey jobKey = JobKey.jobKey(jobName, jobGroup);</div><div class="line">        CronTriggerImpl trigger = (CronTriggerImpl) this.createTrigger(triggerName, triggerGroupName, time);</div><div class="line">        if (scheduler.checkExists(jobKey)) &#123;</div><div class="line">            trigger.setJobName(jobName);</div><div class="line">            trigger.setJobName(jobGroup);</div><div class="line">            scheduler.scheduleJob(trigger);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * 移除一个任务以及它的触发器</div><div class="line">     *</div><div class="line">     */</div><div class="line">    public void removeJob(String jobName, String jobGroup, String triggerName, String triggerGroup) throws SchedulerException &#123;</div><div class="line">        this.pauseTrigger(triggerName, triggerGroup);</div><div class="line">        this.unscheduleJob(triggerName, triggerGroup);</div><div class="line">        this.deleteJob(jobName, jobGroup);</div><div class="line">        log.info(&quot;removeJob success jobName&#123;&#125;,jobGroup&#123;&#125;,triggerName&#123;&#125;,triggerGroup&#123;&#125;&quot;, jobName, jobGroup, triggerName, triggerGroup);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * 获取所有的任务</div><div class="line">     *</div><div class="line">     * @return</div><div class="line">     * @throws SchedulerException</div><div class="line">     */</div><div class="line">    public List&lt;TaskJob&gt; getAllTaskJob() throws SchedulerException &#123;</div><div class="line">        List&lt;TaskJob&gt; list = Lists.newArrayList();</div><div class="line">        for (String groupName : scheduler.getJobGroupNames()) &#123;</div><div class="line">            for (JobKey jobKey : scheduler.getJobKeys(GroupMatcher.jobGroupEquals(groupName))) &#123;</div><div class="line">                JobDetail jobDetail = scheduler.getJobDetail(jobKey);</div><div class="line">                List&lt;Trigger&gt; triggers = (List&lt;Trigger&gt;) scheduler.getTriggersOfJob(jobKey);</div><div class="line">                TaskJob taskJob = new TaskJob();</div><div class="line">                for (Trigger trigger : triggers) &#123;</div><div class="line">                    TriggerState triggerState = scheduler.getTriggerState(trigger.getKey());</div><div class="line">                    taskJob.setTrigger(trigger, triggerState.name());</div><div class="line">                &#125;</div><div class="line">                taskJob.setJobDetail(jobDetail);</div><div class="line">                list.add(taskJob);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        return list;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * 获取正在运行的任务</div><div class="line">     *</div><div class="line">     * @throws SchedulerException</div><div class="line">     */</div><div class="line">    public List&lt;TaskJob&gt; getAllExecutingTaskJob() throws SchedulerException &#123;</div><div class="line">        List&lt;TaskJob&gt; list = Lists.newArrayList();</div><div class="line">        List&lt;JobExecutionContext&gt; currentlyExecutingJobs = scheduler.getCurrentlyExecutingJobs();</div><div class="line">        for (JobExecutionContext jobExecutionContext : currentlyExecutingJobs) &#123;</div><div class="line">            Trigger trigger = jobExecutionContext.getTrigger();</div><div class="line">            TriggerState triggerState = scheduler.getTriggerState(trigger.getKey());</div><div class="line">            TaskJob taskJob = new TaskJob(jobExecutionContext.getJobDetail(), jobExecutionContext.getTrigger(), triggerState.name());</div><div class="line">            list.add(taskJob);</div><div class="line">        &#125;</div><div class="line">        return list;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * 生成触发器</div><div class="line">     */</div><div class="line">    public Trigger createTrigger(String triggerName, String triggerGroup, String cronExpression) &#123;</div><div class="line">        CronScheduleBuilder cronScheduleBuilder = CronScheduleBuilder.cronSchedule(cronExpression);</div><div class="line">        Trigger trigger = TriggerBuilder.newTrigger().withIdentity(triggerName, triggerGroup).withSchedule(cronScheduleBuilder).build();</div><div class="line">        return trigger;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * 生成jobDetail</div><div class="line">     */</div><div class="line">    public JobDetail createJobDetail(String jobName, String jobGroup, String jobClassName, Map&lt;String, Object&gt; dataMap, String description) throws ClassNotFoundException &#123;</div><div class="line">        Class&lt;? extends Job&gt; jobClass = (Class&lt;? extends Job&gt;) Class.forName(jobClassName);</div><div class="line">        JobDetail jobDetail = JobBuilder.newJob(jobClass).withIdentity(jobName, jobGroup).withDescription(description).storeDurably().build();</div><div class="line">        JobDataMap jobDataMap = jobDetail.getJobDataMap();</div><div class="line">        jobDataMap.putAll(dataMap);</div><div class="line">        return jobDetail;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * 获取JobDetail</div><div class="line">     */</div><div class="line">    public JobDetail getJobDetail(String jobName, String jobGroup) throws SchedulerException &#123;</div><div class="line">        JobKey jobKey = JobKey.jobKey(jobName, jobGroup);</div><div class="line">        JobDetail jobDetail = scheduler.getJobDetail(jobKey);</div><div class="line">        return jobDetail;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * 获取Trigger</div><div class="line">     */</div><div class="line">    public Trigger getTrigger(String triggerName, String triggerGroup) throws SchedulerException &#123;</div><div class="line">        TriggerKey triggerKey = TriggerKey.triggerKey(triggerName, triggerGroup);</div><div class="line">        Trigger trigger = scheduler.getTrigger(triggerKey);</div><div class="line">        return trigger;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * 删除相关的job任务</div><div class="line">     *</div><div class="line">     */</div><div class="line">    public boolean deleteJob(String jobName, String jobGroup) throws SchedulerException &#123;</div><div class="line">        JobKey jobKey = JobKey.jobKey(jobName, jobGroup);</div><div class="line">        return scheduler.deleteJob(jobKey);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * 停止一个job任务</div><div class="line">     *</div><div class="line">     * @throws SchedulerException</div><div class="line">     */</div><div class="line">    public void pauseJob(String jobName, String jobGroup) throws SchedulerException &#123;</div><div class="line">        JobKey jobKey = JobKey.jobKey(jobName, jobGroup);</div><div class="line">        scheduler.pauseJob(jobKey);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * 恢复相关的job任务</div><div class="line">     *</div><div class="line">     */</div><div class="line">    public void resumeJob(String jobName, String jobGroup) throws SchedulerException &#123;</div><div class="line">        JobKey jobKey = JobKey.jobKey(jobName, jobGroup);</div><div class="line">        scheduler.resumeJob(jobKey);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * 通过触发器停止调度Job任务</div><div class="line">     *</div><div class="line">     */</div><div class="line">    public boolean unscheduleJob(String triggerName, String triggerGroup) throws SchedulerException &#123;</div><div class="line">        TriggerKey triggerKey = TriggerKey.triggerKey(triggerName, triggerGroup);</div><div class="line">        return scheduler.unscheduleJob(triggerKey);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * 重新恢复触发器相关的job任务</div><div class="line">     *</div><div class="line">     */</div><div class="line">    public Date rescheduleJob(TriggerKey triggerkey, Trigger trigger) throws SchedulerException &#123;</div><div class="line">        return scheduler.rescheduleJob(triggerkey, trigger);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * 停止使用相关的触发器</div><div class="line">     *</div><div class="line">     */</div><div class="line">    public void pauseTrigger(String triggerName, String triggerGroup) throws SchedulerException &#123;</div><div class="line">        TriggerKey triggerKey = TriggerKey.triggerKey(triggerName, triggerGroup);</div><div class="line">        scheduler.pauseTrigger(triggerKey);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * 恢复使用相关的触发器</div><div class="line">     *</div><div class="line">     */</div><div class="line">    public void resumeTrigger(String triggerName, String triggerGroup) throws SchedulerException &#123;</div><div class="line">        TriggerKey triggerKey = TriggerKey.triggerKey(triggerName, triggerGroup);</div><div class="line"></div><div class="line">        scheduler.resumeTrigger(triggerKey);</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>4.创建jobFactory用于job中spring的注入<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">import org.quartz.spi.TriggerFiredBundle;</div><div class="line">import org.springframework.beans.factory.annotation.Autowired;</div><div class="line">import org.springframework.beans.factory.config.AutowireCapableBeanFactory;</div><div class="line">import org.springframework.scheduling.quartz.SpringBeanJobFactory;</div><div class="line">import org.springframework.stereotype.Component;</div><div class="line"></div><div class="line">@Component</div><div class="line">public class AutowireJobFactory extends SpringBeanJobFactory &#123;</div><div class="line"></div><div class="line">    @Autowired</div><div class="line">    private AutowireCapableBeanFactory beanFactory;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    protected Object createJobInstance(TriggerFiredBundle bundle) throws Exception &#123;</div><div class="line">        Object jobInstance = super.createJobInstance(bundle);</div><div class="line">        beanFactory.autowireBean(jobInstance);</div><div class="line">        return jobInstance;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>7.创建全局的job监听<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div></pre></td><td class="code"><pre><div class="line">import org.quartz.*;</div><div class="line">import org.slf4j.Logger;</div><div class="line">import org.slf4j.LoggerFactory;</div><div class="line">import org.springframework.beans.factory.annotation.Autowired;</div><div class="line">import org.springframework.context.ApplicationContext;</div><div class="line">import org.springframework.stereotype.Component;</div><div class="line"></div><div class="line">import java.util.Date;</div><div class="line"></div><div class="line">@Component</div><div class="line">public class GlobalLogJobListener implements JobListener &#123;</div><div class="line"></div><div class="line">    private static Logger log = LoggerFactory.getLogger(GlobalLogJobListener.class);</div><div class="line">    @Autowired</div><div class="line">    private ScheduleLogService scheduleLogService;//用于记录log的service</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public String getName() &#123;</div><div class="line">        return &quot;globalLogJobListener&quot;;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // Scheduler 在 JobDetail 将要被执行时调用这个方法。</div><div class="line">    @Override</div><div class="line">    public void jobToBeExecuted(JobExecutionContext context) &#123;</div><div class="line">        try &#123;</div><div class="line">            ApplicationContext applicationContext = (ApplicationContext) (context.getScheduler().getContext().get(&quot;applicationContext&quot;));</div><div class="line">            scheduleLogService = applicationContext.getBean(ScheduleLogService.class);</div><div class="line">        &#125; catch (SchedulerException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        JobDetail jobDetail = context.getJobDetail();</div><div class="line">        Job jobInstance = context.getJobInstance();</div><div class="line">        this.getScheduleLog(jobDetail);</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // Scheduler 在 JobDetail 即将被执行，但又被 TriggerListener 否决了时调用这个方法。</div><div class="line">    @Override</div><div class="line">    public void jobExecutionVetoed(JobExecutionContext context) &#123;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // Scheduler 在 JobDetail 被执行之后调用这个方法。</div><div class="line">    @Override</div><div class="line">    public void jobWasExecuted(JobExecutionContext context, JobExecutionException jobException) &#123;</div><div class="line">        JobDetail jobDetail = context.getJobDetail();</div><div class="line">        ScheduleLog scheduleLog = this.getScheduleLog(jobDetail);</div><div class="line">        // 执行方法后异常</div><div class="line">        if (jobException != null) &#123;</div><div class="line">            String message = jobException.getMessage();</div><div class="line">            scheduleLog.setResultMessage(message);</div><div class="line">            scheduleLog.setResultCode(0);</div><div class="line">        &#125; else &#123;</div><div class="line">            scheduleLog.setResultMessage(&quot;success&quot;);</div><div class="line">            scheduleLog.setResultCode(1);</div><div class="line">        &#125;</div><div class="line">        ScheduleLog create = this.scheduleLogService.create(scheduleLog);</div><div class="line">        log.info(&quot;excute job result:&#123;&#125;&quot;, create);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public ScheduleLog getScheduleLog(JobDetail jobDetail) &#123;</div><div class="line">        ScheduleLog scheduleLog = (ScheduleLog) jobDetail.getJobDataMap().get(&quot;scheduleLog&quot;);</div><div class="line">        if (scheduleLog == null) &#123;</div><div class="line">            JobKey key = jobDetail.getKey();</div><div class="line">            scheduleLog = new ScheduleLog();</div><div class="line">            scheduleLog.setJobName(key.getName());</div><div class="line">            scheduleLog.setJobGroup(key.getGroup());</div><div class="line">            scheduleLog.setStartTime(new Date());</div><div class="line">            jobDetail.getJobDataMap().put(&quot;scheduleLog&quot;, scheduleLog);</div><div class="line">        &#125;</div><div class="line">        scheduleLog.setEndTime(new Date());</div><div class="line">        return scheduleLog;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>8.创建job，继承Job接口<br>9.最后提供接口，让job可配置化，可以从界面上操控job</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/09/支付宝支付/" itemprop="url">
                  支付宝支付
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-04-09T12:00:00+08:00" content="2017-04-09">
              2017-04-09
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/spring-boot/" itemprop="url" rel="index">
                    <span itemprop="name">spring boot</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2017/04/09/支付宝支付/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/04/09/支付宝支付/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>先导入第三方jar包<br>建立基类，所有支付类型都继承它<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div></pre></td><td class="code"><pre><div class="line">import java.util.*;</div><div class="line"></div><div class="line">import org.slf4j.*;</div><div class="line">import org.springframework.beans.factory.annotation.Value;</div><div class="line">import org.springframework.stereotype.Service;</div><div class="line"></div><div class="line">import com.alipay.api.*;</div><div class="line">import com.alipay.api.internal.util.AlipaySignature;</div><div class="line">import com.alipay.api.request.*;</div><div class="line">import com.alipay.api.response.*;</div><div class="line"></div><div class="line">import cn.swao.baselib.util.*;</div><div class="line"></div><div class="line">@Service</div><div class="line">public class AliParamService &#123;</div><div class="line">    private static Logger log = LoggerFactory.getLogger(AliParamService.class);</div><div class="line"></div><div class="line">    @Value(&quot;$&#123;partner:&#125;&quot;)</div><div class="line">    protected String partner;</div><div class="line"></div><div class="line">    @Value(&quot;$&#123;private_key:&#125;&quot;)</div><div class="line">    protected String private_key;</div><div class="line"></div><div class="line">    @Value(&quot;$&#123;public_key:&#125;&quot;)</div><div class="line">    protected String public_key;</div><div class="line"></div><div class="line">    @Value(&quot;$&#123;alipay_public_key:&#125;&quot;)</div><div class="line">    protected String alipay_public_key;</div><div class="line"></div><div class="line">    @Value(&quot;$&#123;notify_url:&#125;&quot;)</div><div class="line">    protected String notify_url;</div><div class="line"></div><div class="line">    @Value(&quot;$&#123;app_id:&#125;&quot;)</div><div class="line">    protected String app_id;</div><div class="line"></div><div class="line">    @Value(&quot;$&#123;timeout_express:&#125;&quot;)</div><div class="line">    protected String timeout_express;</div><div class="line"></div><div class="line">    protected String sign_type = &quot;RSA&quot;;</div><div class="line"></div><div class="line">    protected String input_charset = &quot;utf-8&quot;;</div><div class="line"></div><div class="line">    protected String format = &quot;json&quot;;</div><div class="line"></div><div class="line">    protected String version = &quot;1.0&quot;;</div><div class="line"></div><div class="line">    protected AlipayClient alipayClient = null;</div><div class="line"></div><div class="line">    public void getClient(String requestUrl) &#123;</div><div class="line">        alipayClient = new DefaultAlipayClient(requestUrl, app_id, private_key, format, input_charset, alipay_public_key);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 异步 synNotify</div><div class="line">    public boolean asynNotify(Map&lt;String, String&gt; map) &#123;</div><div class="line">        boolean flag = false;</div><div class="line">        try &#123;</div><div class="line">            log.info(LogUtils.gen(&quot;map&quot;, map));</div><div class="line">            if (partner.equals(map.get(&quot;seller_id&quot;)) &amp;&amp; app_id.equals(map.get(&quot;app_id&quot;))) &#123;</div><div class="line">                log.info(&quot;partner:&quot; + partner + &quot;seller_id&quot; + map.get(&quot;seller_id&quot;));</div><div class="line">                flag = AlipaySignature.rsaCheckV1(map, alipay_public_key, input_charset);</div><div class="line">            &#125;</div><div class="line">        &#125; catch (AlipayApiException e) &#123;</div><div class="line">            log.info(&quot;异步通知校验失败&quot;, e);</div><div class="line">            flag = false;</div><div class="line">        &#125;</div><div class="line">        return flag;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 同步</div><div class="line">    public boolean synNotify(Map&lt;String, String&gt; alipay, String sign) &#123;</div><div class="line">        boolean flag = false;</div><div class="line">        log.info(&quot;同步验证参数，alipay=&#123;&#125;,sign=&#123;&#125;&quot;, alipay, sign);</div><div class="line">        try &#123;</div><div class="line">            if (partner.equals(alipay.get(&quot;seller_id&quot;)) &amp;&amp; app_id.equals(alipay.get(&quot;app_id&quot;))) &#123;</div><div class="line">                log.info(&quot;开始同步签名验证&quot;);</div><div class="line">                flag = AlipaySignature.rsaCheckContent(JSONUtils.toJson(alipay).toString(), sign, alipay_public_key, input_charset);</div><div class="line">            &#125;</div><div class="line">        &#125; catch (AlipayApiException e) &#123;</div><div class="line">            log.info(&quot;同步通知校验失败&quot;, e);</div><div class="line">            flag = false;</div><div class="line">        &#125;</div><div class="line">        return flag;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * out_trade_no 支付时传入的商户订单号，与trade_no必填一个 trade_no 支付时返回的支付宝交易号，与out_trade_no必填一个</div><div class="line">     */</div><div class="line">    public String queryOrder(Map&lt;String, String&gt; map) &#123;</div><div class="line">        AlipayTradeQueryRequest request = new AlipayTradeQueryRequest();// 创建API对应的request类</div><div class="line">        AlipayTradeQueryResponse response = null;</div><div class="line">        String result = null;</div><div class="line">        try &#123;</div><div class="line">            request.setBizContent(JSONUtils.toJson(AlipayCore.emptyFilter(map)).toString());// 设置业务参数</div><div class="line">            response = alipayClient.execute(request);</div><div class="line">            result = response.getBody();</div><div class="line">        &#125; catch (AlipayApiException e) &#123;</div><div class="line">            log.info(&quot;查询订单失败&#123;&#125;&quot;, map);</div><div class="line">        &#125;</div><div class="line">        return result;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 退款</div><div class="line">    public Map&lt;String, Object&gt; refund(Map&lt;String, String&gt; map) &#123;</div><div class="line">        log.info(&quot;ali开始退款&quot;);</div><div class="line">        log.info(LogUtils.gen(&quot;map&quot;, map));</div><div class="line">        AlipayTradeRefundRequest request = new AlipayTradeRefundRequest();</div><div class="line">        request.setBizContent(JSONUtils.toJson(AlipayCore.emptyFilter(map)).toString());</div><div class="line">        AlipayTradeRefundResponse response = null;</div><div class="line">        boolean flag = false;</div><div class="line">        String msg = null;</div><div class="line">        String subCode = null;</div><div class="line">        String out_trade_no = null;</div><div class="line">        Map&lt;String, Object&gt; data = new HashMap&lt;String, Object&gt;();</div><div class="line">        try &#123;</div><div class="line">            response = alipayClient.execute(request);</div><div class="line">            out_trade_no = response.getOutTradeNo();</div><div class="line">            // Map body = WebUtils.getJsonParams(response.getBody());</div><div class="line">        &#125; catch (Exception e) &#123;</div><div class="line">            msg = &quot;退款失败:&quot; + e;</div><div class="line">            log.info(msg);</div><div class="line">            data.put(&quot;flag&quot;, flag);</div><div class="line">            data.put(&quot;msg&quot;, &quot;退款失败&quot;);</div><div class="line">            return data;</div><div class="line">        &#125;</div><div class="line">        if (response != null &amp;&amp; response.isSuccess()) &#123;</div><div class="line">            String fundChange = response.getFundChange();</div><div class="line">            if (&quot;Y&quot;.equals(fundChange)) &#123;</div><div class="line">                flag = true;</div><div class="line">                msg = &quot;退款成功&quot;;</div><div class="line">                data.put(&quot;out_trade_no&quot;, out_trade_no);</div><div class="line">                data.put(&quot;refund_fee&quot;, response.getRefundFee());</div><div class="line">                data.put(&quot;gmtRefundPay&quot;, response.getGmtRefundPay());</div><div class="line">                data.put(&quot;buyer_logon_id&quot;, response.getBuyerLogonId());</div><div class="line">            &#125; else if (&quot;N&quot;.equals(fundChange)) &#123;</div><div class="line">                msg = &quot;已完成退款，不可重复退款&quot;;</div><div class="line">                flag = false;</div><div class="line">            &#125;</div><div class="line">        &#125; else &#123;</div><div class="line">            msg = response.getSubMsg();</div><div class="line">            subCode = response.getSubCode();</div><div class="line">            flag = false;</div><div class="line">        &#125;</div><div class="line">        data.put(&quot;msg&quot;, msg);</div><div class="line">        data.put(&quot;flag&quot;, flag);</div><div class="line">        data.put(&quot;subCode&quot;, subCode);</div><div class="line">        log.info(LogUtils.gen(&quot;refund return&quot;, &quot;out_trade_no&quot;, out_trade_no, &quot;msg&quot;, msg, &quot;subCode&quot;, subCode));</div><div class="line">        return data;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>基类提供了获取支付对象、查询、退款的方法<br>1.app支付<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line">import java.util.*;</div><div class="line"></div><div class="line">import javax.annotation.PostConstruct;</div><div class="line"></div><div class="line">import org.slf4j.*;</div><div class="line">import org.springframework.stereotype.Service;</div><div class="line"></div><div class="line">import com.alipay.api.AlipayApiException;</div><div class="line">import com.alipay.api.internal.util.AlipaySignature;</div><div class="line"></div><div class="line">import cn.swao.baselib.util.*;</div><div class="line"></div><div class="line">@Service</div><div class="line">public class AlipayService extends AliParamService &#123;</div><div class="line"></div><div class="line">    private static Logger log = LoggerFactory.getLogger(AlipayService.class);</div><div class="line"></div><div class="line">    private String method = &quot;alipay.trade.app.pay&quot;;</div><div class="line"></div><div class="line">    private String ALIPAY_GATEWAY_NEW = &quot;https://mapi.alipay.com/gateway.do?&quot;;</div><div class="line"></div><div class="line">    @PostConstruct</div><div class="line">    public void init() &#123;</div><div class="line">        super.getClient(ALIPAY_GATEWAY_NEW);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 获取签名</div><div class="line">    public String buildRequestPara(Map&lt;String, String&gt; sParaTemp) throws Exception &#123;</div><div class="line">        log.info(&quot;ali开始获取签名&quot;);</div><div class="line">        log.info(LogUtils.gen(&quot;sParaTemp&quot;, sParaTemp));</div><div class="line">        Map&lt;String, String&gt; map = new HashMap&lt;String, String&gt;();</div><div class="line">        map.put(&quot;app_id&quot;, app_id);</div><div class="line">        map.put(&quot;method&quot;, method);</div><div class="line">        map.put(&quot;format&quot;, format);</div><div class="line">        map.put(&quot;charset&quot;, input_charset);</div><div class="line">        map.put(&quot;sign_type&quot;, sign_type);</div><div class="line">        map.put(&quot;notify_url&quot;, notify_url);</div><div class="line">        map.put(&quot;timestamp&quot;, DateUtils.toDateTimeString(new Date()));</div><div class="line">        map.put(&quot;version&quot;, version);</div><div class="line">        sParaTemp.put(&quot;seller_id&quot;, partner);</div><div class="line">        sParaTemp.put(&quot;timeout_express&quot;, timeout_express);</div><div class="line">        map.put(&quot;biz_content&quot;, JSONUtils.toJson(sParaTemp).toString());</div><div class="line">        String sign = AlipaySignature.rsaSign(map, private_key, input_charset);</div><div class="line">        map.put(&quot;sign&quot;, sign);</div><div class="line">        String linkString = AlipayCore.encodeMap2String(map);</div><div class="line">        log.info(&quot;签名alipay:&quot; + linkString);</div><div class="line"></div><div class="line">        return linkString;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>其他app支付的验签查询的方法都来自父类</p>
<p>2.网页支付和扫码支付<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div></pre></td><td class="code"><pre><div class="line">import cn.swao.baselib.util.JSONUtils;</div><div class="line">import com.alipay.api.AlipayApiException;</div><div class="line">import com.alipay.api.request.AlipayTradePrecreateRequest;</div><div class="line">import com.alipay.api.request.AlipayTradeWapPayRequest;</div><div class="line">import com.alipay.api.response.AlipayTradePrecreateResponse;</div><div class="line">import org.assertj.core.util.Strings;</div><div class="line">import org.slf4j.Logger;</div><div class="line">import org.slf4j.LoggerFactory;</div><div class="line">import org.springframework.beans.factory.annotation.Value;</div><div class="line">import org.springframework.stereotype.Service;</div><div class="line"></div><div class="line">import javax.annotation.PostConstruct;</div><div class="line">import java.io.UnsupportedEncodingException;</div><div class="line">import java.net.URLEncoder;</div><div class="line">import java.util.Map;</div><div class="line"></div><div class="line">@Service</div><div class="line">public class AliMpService extends AliParamService &#123;</div><div class="line"></div><div class="line">    private static Logger log = LoggerFactory.getLogger(AliMpService.class);</div><div class="line">    private String method = &quot;alipay.trade.wap.pay&quot;;</div><div class="line">    private String ALIPAY_OPEN_NEW = &quot;https://openapi.alipay.com/gateway.do&quot;;</div><div class="line">    private String apiVersion = &quot;3&quot;;</div><div class="line">    private String product_code = &quot;QUICK_WAP_PAY&quot;;</div><div class="line">    @Value(&quot;$&#123;returnUrl:&#125;&quot;)</div><div class="line">    private String return_url;</div><div class="line"></div><div class="line">    @Value(&quot;$&#123;qrCodeUrl:&#125;&quot;)</div><div class="line">    public String LIANTU_URL;//生成二维码</div><div class="line"></div><div class="line">    @PostConstruct</div><div class="line">    public void init() &#123;</div><div class="line">        super.getClient(ALIPAY_OPEN_NEW);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 手机网站支付下单</div><div class="line">    public String buildRequestPara(Map&lt;String, String&gt; sParaTemp) throws Exception &#123;</div><div class="line">        AlipayTradeWapPayRequest alipayRequest = new AlipayTradeWapPayRequest();// 创建API对应的request</div><div class="line">        alipayRequest.setNotifyUrl(notify_url);</div><div class="line">        alipayRequest.setApiVersion(apiVersion);</div><div class="line">        if (!Strings.isNullOrEmpty(sParaTemp.get(&quot;selfparam&quot;))) &#123;</div><div class="line">            String returnUrl = new StringBuffer(return_url).append(&quot;?selfparam=&quot;).append(sParaTemp.get(&quot;selfparam&quot;)).toString();</div><div class="line">            alipayRequest.setReturnUrl(returnUrl);</div><div class="line">            sParaTemp.remove(&quot;selfparam&quot;);</div><div class="line">        &#125; else &#123;</div><div class="line">            alipayRequest.setReturnUrl(return_url);</div><div class="line">        &#125;</div><div class="line">        sParaTemp.put(&quot;product_code&quot;, product_code);</div><div class="line">        String biz_content = JSONUtils.toJson(AlipayCore.emptyFilter(sParaTemp)).toString();</div><div class="line">        alipayRequest.setBizContent(biz_content);</div><div class="line">        log.info(&quot;支付宝手机网站支付业务参数：&#123;&#125;&quot;, alipayRequest);</div><div class="line">        String form = super.alipayClient.pageExecute(alipayRequest).getBody();</div><div class="line">        log.info(&quot;支付宝手机网站支付下单后参数：&#123;&#125;&quot;, form);</div><div class="line">        return form;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * 扫码支付生成二维码 map中必要参数 out_trade_no,total_amount,subject,store_id(门店编号)</div><div class="line">     */</div><div class="line">    public String buildRequestQrCode(Map&lt;String, String&gt; sParaTemp) &#123;</div><div class="line"></div><div class="line">        AlipayTradePrecreateRequest request = new AlipayTradePrecreateRequest();</div><div class="line">        request.setNotifyUrl(notify_url);</div><div class="line">        sParaTemp.put(&quot;timeout_express&quot;, timeout_express);</div><div class="line"></div><div class="line">        String bizContent = JSONUtils.toJson(sParaTemp);</div><div class="line">        request.setBizContent(bizContent);</div><div class="line">        log.info(&quot;扫码预下单:sParaTemp:&#123;&#125;&quot;, sParaTemp);</div><div class="line">        try &#123;</div><div class="line">            AlipayTradePrecreateResponse execute = super.alipayClient.execute(request);</div><div class="line">            String qrCode = execute.getQrCode();</div><div class="line">            String qrCodeUrl = LIANTU_URL + URLEncoder.encode(qrCode, &quot;UTF-8&quot;);</div><div class="line">            String body = execute.getBody();</div><div class="line">            log.info(&quot;qrCode:&#123;&#125;,qrCodeUrl:&#123;&#125;,AlipayTradePrecreateResponse.Body:&#123;&#125;&quot;, qrCode, qrCodeUrl, body);</div><div class="line">            return qrCodeUrl;</div><div class="line">        &#125; catch (AlipayApiException | UnsupportedEncodingException e) &#123;</div><div class="line">            log.error(&quot;扫码预下单失败&quot;, e);</div><div class="line">            return null;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/09/微信支付/" itemprop="url">
                  微信支付
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-04-09T12:00:00+08:00" content="2017-04-09">
              2017-04-09
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/spring-boot/" itemprop="url" rel="index">
                    <span itemprop="name">spring boot</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2017/04/09/微信支付/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/04/09/微信支付/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p id="build"></p>


<p>先导入微信的第三方依赖</p>
<pre><code>&lt;dependency&gt;
    &lt;groupId&gt;me.hao0&lt;/groupId&gt;
    &lt;artifactId&gt;wepay-core&lt;/artifactId&gt;
    &lt;version&gt;1.1.2&lt;/version&gt;
&lt;/dependency&gt;
</code></pre><p>先建微信支付的基类，然后各种支付类型的实现继承它</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div></pre></td><td class="code"><pre><div class="line">import java.math.BigDecimal;</div><div class="line">import java.text.SimpleDateFormat;</div><div class="line">import java.util.Map;</div><div class="line"></div><div class="line">import org.slf4j.*;</div><div class="line"></div><div class="line">import com.google.common.base.Strings;</div><div class="line"></div><div class="line">import cn.swao.baselib.util.*;</div><div class="line">import me.hao0.wepay.core.*;</div><div class="line">import me.hao0.wepay.exception.WepayException;</div><div class="line">import me.hao0.wepay.model.order.WePayOrder;</div><div class="line">import me.hao0.wepay.model.refund.*;</div><div class="line"></div><div class="line">public class WxPayService &#123;</div><div class="line"></div><div class="line">    private static Logger log = LoggerFactory.getLogger(WxPayService.class);</div><div class="line"></div><div class="line">    public Wepay wepay = null;</div><div class="line"></div><div class="line">    public final static SimpleDateFormat wxTimeFormat = new SimpleDateFormat(&quot;yyyyMMddHHmmss&quot;);</div><div class="line"></div><div class="line">    public String merchant = null;</div><div class="line"></div><div class="line">    public void setMerchant(String merchant) &#123;</div><div class="line">        this.merchant = merchant;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public Wepay initWepay(String certPath, String appId, String payKey, String payMerchant, String certPasswd) &#123;</div><div class="line">        if (Strings.isNullOrEmpty(certPath)) &#123;</div><div class="line">            log.info(&quot;WxPay : no init.&quot;);</div><div class="line">        &#125; else &#123;</div><div class="line">            log.info(&quot;WxPay : init. &quot; + certPath);</div><div class="line">            byte[] data = FsUtils.readBinaryFile(certPath);//读取证书</div><div class="line">            if (data == null)</div><div class="line">                log.error(&quot;WxPay : read cert error. &quot; + certPath);</div><div class="line">            else</div><div class="line">                this.wepay = WepayBuilder.newBuilder(appId, payKey, payMerchant).certPasswd(certPasswd).certs(data).build();</div><div class="line">        &#125;</div><div class="line">        return this.wepay;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public Notifies getNotifies() &#123;</div><div class="line">        return this.wepay.notifies();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 异步通知检验</div><div class="line">    public boolean notifyVerify(Map&lt;String, ?&gt; map) &#123;</div><div class="line">        return getNotifies().verifySign(map);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 订单查询</div><div class="line">    public WePayOrder getOrder(String outTradeNo) &#123;</div><div class="line">        try &#123;</div><div class="line">            return this.wepay.order().queryByOutTradeNo(outTradeNo);</div><div class="line">        &#125; catch (WepayException e) &#123;</div><div class="line">            log.error(&quot;WxPay getOrder&quot;, e);</div><div class="line">            return null;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 退款</div><div class="line">    public RefundApplyResponse refund(String outTradeNo, BigDecimal fee) &#123;</div><div class="line">        try &#123;</div><div class="line">            log.info(LogUtils.gen(&quot;WxPay refund&quot;, &quot;out_trade_no&quot;, outTradeNo));</div><div class="line">            Integer totalFee = fee.multiply(new BigDecimal(100)).intValue();</div><div class="line">            RefundApplyRequest req = new RefundApplyRequest();</div><div class="line">            req.setOutTradeNo(outTradeNo);</div><div class="line">            req.setOutRefundNo(outTradeNo);</div><div class="line">            req.setTotalFee(totalFee);</div><div class="line">            req.setRefundFee(totalFee);</div><div class="line">            req.setOpUserId(this.merchant);</div><div class="line"></div><div class="line">            RefundApplyResponse result = this.wepay.refund().apply(req);</div><div class="line">            log.info(LogUtils.gen(&quot;WxPay sucess&quot;, &quot;RefundApplyResponse&quot;, result.toString()));</div><div class="line">            return result;</div><div class="line">        &#125; catch (WepayException e) &#123;</div><div class="line">            log.error(&quot;WxPay refund&quot;, e);</div><div class="line">            return null;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 退款查询</div><div class="line">    public RefundQueryResponse getRefund(String outTradeNo) &#123;</div><div class="line">        try &#123;</div><div class="line">            return wepay.refund().queryByOutTradeNo(outTradeNo);</div><div class="line">        &#125; catch (WepayException e) &#123;</div><div class="line">            log.error(&quot;WxPay getRefund&quot;, e);</div><div class="line">            return null;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>initWepay是对微信支付client对象初始化，其中还有通用的退款、查询、异步通知校验的方法。</p>
<p>1.app支付<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div></pre></td><td class="code"><pre><div class="line">import java.math.BigDecimal;</div><div class="line">import java.net.*;</div><div class="line">import java.util.Map;</div><div class="line"></div><div class="line">import javax.annotation.PostConstruct;</div><div class="line"></div><div class="line">import org.slf4j.*;</div><div class="line">import org.springframework.beans.factory.annotation.Value;</div><div class="line">import org.springframework.stereotype.Service;</div><div class="line"></div><div class="line">import com.google.common.base.Strings;</div><div class="line">import com.google.common.collect.Maps;</div><div class="line">import com.google.gson.JsonObject;</div><div class="line"></div><div class="line">import cn.swao.baselib.util.*;</div><div class="line">import me.hao0.wepay.model.pay.*;</div><div class="line"></div><div class="line">@Service</div><div class="line">public class WxAppService extends WxPayService &#123;</div><div class="line"></div><div class="line">    private static Logger log = LoggerFactory.getLogger(WeixinMpService.class);</div><div class="line"></div><div class="line">    @Value(&quot;$&#123;open.appId:&#125;&quot;)</div><div class="line">    private String appId = null;</div><div class="line">    @Value(&quot;$&#123;open.appSecret:&#125;&quot;)</div><div class="line">    private String appSecret = null;</div><div class="line">    @Value(&quot;$&#123;open.pay.Merchant:&#125;&quot;)</div><div class="line">    private String payMerchant = null;</div><div class="line">    @Value(&quot;$&#123;open.pay.Key:&#125;&quot;)</div><div class="line">    private String payKey = null;</div><div class="line">    @Value(&quot;$&#123;open.pay.CertPasswd:&#125;&quot;)</div><div class="line">    private String certPasswd = null;</div><div class="line">    @Value(&quot;$&#123;open.pay.CertPath:&#125;&quot;)</div><div class="line">    private String certPath = null;</div><div class="line">    @Value(&quot;$&#123;open.pay.notifyUrl:&#125;&quot;)</div><div class="line">    private String payNotifyUrl = null;</div><div class="line"></div><div class="line">    @PostConstruct</div><div class="line">    private void init() &#123;</div><div class="line">        initWepay(certPath, appId, payKey, payMerchant, certPasswd);</div><div class="line">        setMerchant(this.payMerchant);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // app支付</div><div class="line">    public AppPayResponse getAppPay(String outTradeNo, BigDecimal fee, String body, String ip) &#123;</div><div class="line">        log.info(LogUtils.gen(&quot;wxapp下单&quot;, &quot;out_trade_no&quot;, outTradeNo, &quot;body&quot;, body, &quot;ip&quot;, ip));</div><div class="line">        PayRequest app = new PayRequest();</div><div class="line">        int totalFee = FinanceUtils.toFen(fee);</div><div class="line">        app.setBody(body);</div><div class="line">        app.setNotifyUrl(this.payNotifyUrl);</div><div class="line">        app.setOutTradeNo(outTradeNo);</div><div class="line">        app.setTotalFee(totalFee);</div><div class="line">        if (Strings.isNullOrEmpty(ip)) &#123;</div><div class="line">            try &#123;</div><div class="line">                ip = InetAddress.getLocalHost().getHostAddress();//如果ip为空，那么拿本机ip(防止拿不到ip导致的异常)</div><div class="line">            &#125; catch (UnknownHostException e) &#123;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        app.setClientId(ip);</div><div class="line">        app.setTimeStart(DateUtils.nowString(wxTimeFormat));</div><div class="line">        Map&lt;String, Object&gt; attachMap = Maps.newHashMap();</div><div class="line">        attachMap.put(&quot;out_trade_no&quot;, outTradeNo);</div><div class="line">        attachMap.put(&quot;wxPayWay&quot;, &quot;JSAPI&quot;);</div><div class="line">        app.setAttach(JSONUtils.toJson(attachMap));</div><div class="line"></div><div class="line">        try &#123;</div><div class="line">            log.info(LogUtils.gen(&quot;app&quot;, app.toString()));</div><div class="line">            AppPayResponse appPay = super.wepay.pay().appPay(app);</div><div class="line">            log.info(LogUtils.gen(&quot;wxapp下单成功&quot;, &quot;appPay&quot;, appPay.toString()));</div><div class="line">            return appPay;</div><div class="line">        &#125; catch (Exception e) &#123;</div><div class="line">            log.error(&quot;WxAppService getAppPay&quot;, e);</div><div class="line">            return null;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>其中的方法是app统一支付下单的方法，其他的查询和异步验签只需要用父类的方法。@Value中的参数写在配置文件中，这些参数是app支付必要的一些参数 ,@PostConstruct项目启动后调用，获取微信支付的对象。<br>2.微信公众号支付和扫码支付</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div></pre></td><td class="code"><pre><div class="line">import cn.swao.baselib.model.NotifyTemplates;</div><div class="line">import cn.swao.baselib.util.*;</div><div class="line">import com.google.common.base.Strings;</div><div class="line">import com.google.common.collect.Maps;</div><div class="line">import com.google.gson.JsonObject;</div><div class="line">import me.hao0.wepay.exception.WepayException;</div><div class="line">import me.hao0.wepay.model.pay.JsPayRequest;</div><div class="line">import me.hao0.wepay.model.pay.JsPayResponse;</div><div class="line">import me.hao0.wepay.model.pay.QrPayRequest;</div><div class="line">import org.slf4j.Logger;</div><div class="line">import org.slf4j.LoggerFactory;</div><div class="line">import org.springframework.beans.factory.annotation.Value;</div><div class="line">import org.springframework.stereotype.Service;</div><div class="line"></div><div class="line">import javax.annotation.PostConstruct;</div><div class="line">import java.math.BigDecimal;</div><div class="line">import java.util.*;</div><div class="line"></div><div class="line">@Service</div><div class="line">public class WeixinMpService extends WxPayService &#123;</div><div class="line">    private static Logger log = LoggerFactory.getLogger(WeixinMpService.class);</div><div class="line"></div><div class="line">    @Value(&quot;$&#123;mp.appId:&#125;&quot;)</div><div class="line">    private String appId = null;</div><div class="line">    @Value(&quot;$&#123;mp.appSecret:&#125;&quot;)</div><div class="line">    private String appSecret = null;</div><div class="line">    @Value(&quot;$&#123;mp.pay.Merchant:&#125;&quot;)</div><div class="line">    private String payMerchant = null;</div><div class="line">    @Value(&quot;$&#123;mp.pay.Key:&#125;&quot;)</div><div class="line">    private String payKey = null;</div><div class="line">    @Value(&quot;$&#123;mp.pay.CertPasswd:&#125;&quot;)</div><div class="line">    private String certPasswd = null;</div><div class="line">    @Value(&quot;$&#123;mp.pay.CertPath:&#125;&quot;)</div><div class="line">    private String certPath = null;</div><div class="line">    @Value(&quot;$&#123;mp.pay.notifyUrl:&#125;&quot;)</div><div class="line">    private String payNotifyUrl = null;</div><div class="line"></div><div class="line">    @PostConstruct</div><div class="line">    private void init() &#123;</div><div class="line">        initWepay(this.certPath, this.appId, this.payKey, this.payMerchant, this.certPasswd);</div><div class="line">        setMerchant(this.payMerchant);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    // 微信公众号支付</div><div class="line">    public JsPayResponse getJsPay(String outTradeNo, BigDecimal fee, String body, String ip, String openid) &#123;</div><div class="line">        log.info(LogUtils.gen(&quot;开始统一下单&quot;, &quot;out_trade_no&quot;, outTradeNo, &quot;body&quot;, body, &quot;ip&quot;, ip, &quot;openid&quot;, openid));</div><div class="line">        int totalFee = FinanceUtils.toFen(fee);</div><div class="line">        JsPayRequest jpr = new JsPayRequest();</div><div class="line">        jpr.setBody(body);</div><div class="line">        jpr.setNotifyUrl(this.payNotifyUrl);</div><div class="line">        jpr.setOutTradeNo(outTradeNo);</div><div class="line">        jpr.setTotalFee(totalFee);</div><div class="line">        if (Strings.isNullOrEmpty(ip))</div><div class="line">            ip = SysUtils.getIp();</div><div class="line">        jpr.setClientId(ip);</div><div class="line">        jpr.setOpenId(openid);</div><div class="line">        jpr.setTimeStart(DateUtils.nowString(wxTimeFormat));</div><div class="line">        Map&lt;String, Object&gt; attachMap = Maps.newHashMap();</div><div class="line">        attachMap.put(&quot;out_trade_no&quot;, outTradeNo);</div><div class="line">        attachMap.put(&quot;wxPayWay&quot;, &quot;JSAPI&quot;);</div><div class="line">        jpr.setAttach(JSONUtils.toJson(attachMap));</div><div class="line"></div><div class="line">        try &#123;</div><div class="line">            log.info(LogUtils.gen(&quot;jpr&quot;, jpr.toString()));</div><div class="line">            JsPayResponse jsPay = this.wepay.pay().jsPay(jpr);</div><div class="line">            log.info(LogUtils.gen(&quot;统一下单成功&quot;, &quot;JsPayResponse&quot;, jsPay.toString()));</div><div class="line">            return jsPay;</div><div class="line">        &#125; catch (WepayException e) &#123;</div><div class="line">            log.error(&quot;WeixinService getJsPay&quot;, e);</div><div class="line">            return null;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    //扫码支付</div><div class="line">    public String getQrPay(String outTradeNo, BigDecimal fee, String body, String ip, String productId) &#123;</div><div class="line">        log.info(LogUtils.gen(&quot;开始统一下单&quot;, &quot;out_trade_no&quot;, outTradeNo, &quot;body&quot;, body, &quot;ip&quot;, ip, &quot;productId&quot;, productId));</div><div class="line">        QrPayRequest qr = new QrPayRequest();</div><div class="line">        int totalFee = FinanceUtils.toFen(fee);</div><div class="line"></div><div class="line">        qr.setBody(body);</div><div class="line">        qr.setNotifyUrl(this.payNotifyUrl);</div><div class="line">        qr.setOutTradeNo(outTradeNo);</div><div class="line">        qr.setTotalFee(totalFee);</div><div class="line">        if (Strings.isNullOrEmpty(ip))</div><div class="line">            ip = SysUtils.getIp();//获取本机地址ip</div><div class="line">        qr.setClientId(ip);</div><div class="line">        qr.setTimeStart(DateUtils.nowString(wxTimeFormat));</div><div class="line">        qr.setProductId(productId);</div><div class="line">        String codeUrl = null;</div><div class="line">        try &#123;</div><div class="line">            codeUrl = this.wepay.pay().qrPay(qr);</div><div class="line">            log.info(&quot;扫码支付 codeUrl:&#123;&#125;&quot;, codeUrl);</div><div class="line">        &#125; catch (Exception e) &#123;</div><div class="line">            log.error(&quot;扫码支付下单失败&quot;, e);</div><div class="line">        &#125;</div><div class="line">        return codeUrl;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="http://oahout86t.bkt.clouddn.com/a.jpg"
               alt="坐看流云" />
          <p class="site-author-name" itemprop="name">坐看流云</p>
          <p class="site-description motion-element" itemprop="description">一步一个脚印</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">4</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">2</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">4</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">kwgen</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.pisces
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.1"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"bokekwg"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    <script src="/vendors/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  






  
  

  

  

  

</body>
</html>
